=== Nginx

==== 概况
`Nginx` 作为代理层，提供了负载均衡功能，承担 `Usergrid REST` / IM REST 的接入和 www， webim， console服务的静态页面服务。
`Nginx` 服务器的角色名为 `web`，每个集群中至少配置2台实例。

===== 版本
nginx 安装版本为 `Tengine/2.0.3`，安装时配置参数为:

[source,console]
----
./configure --with-http_geoip_module --with-http_lua_module --add-module=ngx_http_accounting_module --with-syslog --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-file-aio --with-cc-opt='-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic' --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --prefix=/home/easemob/apps/opt/nginx-1.7.2 --conf-path=/home/easemob/apps/config/nginx/nginx.conf --user=easemob --group=easemob --pid-path=/home/easemob/apps/var/nginx/nginx.pid --error-log-path=/home/easemob/apps/log/nginx/error.log --http-log-path=/home/easemob/apps/log/nginx/access.log --sbin-path=/home/easemob/apps/opt/nginx-1.7.2/sbin/nginx --lock-path=/home/easemob/apps/var/nginx/nginx.lock --http-client-body-temp-path=/home/easemob/apps/var/nginx/client_temp --http-proxy-temp-path=/home/easemob/apps/var/nginx/proxy_temp --http-fastcgi-temp-path=/home/easemob/apps/var/nginx/fastcgi_temp --http-uwsgi-temp-path=/home/easemob/apps/var/nginx/uwsgi_temp --http-scgi-temp-path=/home/easemob/apps/var/nginx/scgi_temp
----

==== 基本操作命令

测试配置文件的语法正确性：
[source,console]
----
sudo /data/apps/opt/nginx/sbin/nginx -t
----

重新加载配置文件
[source,console]
----
sudo /data/apps/opt/nginx/sbin/nginx -s reload
----

配置文件同步：使用 `scp` 将配置文件拷贝到同集群其它web机器上对应位置。

==== 配置文件概况

配置文件保存在 `/data/apps/config/nginx/` 目录，目录结构如下

[source]
----
/data/apps/config/nginx/
├── conf.d
│   ├── a1.easemob.com.conf
│   ├── a2.easemob.com.conf
│   ├── console.easemob.com.conf
│   ├── dl.easemob.com.conf
│   ├── im-api.easemob.com.conf
│   ├── include
│   │   ├── a1-cors
│   │   ├── a1-drop-android-post-devices
│   │   ├── a1-headers
│   │   ├── a1-map-uri-easemob_api
│   │   ├── a1-mp3header
│   │   └── proxy.cfg
│   ├── stage.easemob.com.conf
│   ├── webim.easemob.com.conf
│   └── www.easemob.com.conf
├── geoip
│   ├── GeoIP.dat
│   └── GeoLiteCity.dat
├── https
│   ├── a1.crt
│   ├── a1-decrept.crt
│   ├── a1-decrept.key
│   ├── a1.key
├── mime.types
└── nginx.conf
----

所有独立站点配置保存在 `conf.d/` 目录下单独文件中，基本文件名为站点主域名，扩展名为 `.conf`。

==== 作为负载均衡的配置
===== 适用范围
作为负载均衡的站点包括

* Usergrid REST
** a1.easemob.com
** a1.vip1.easemob.com
* IM API & http bind
** im-api.easemob.com
** im-api.vip1.easemob.com

===== 配置规则

* 访问日志
** 每个站点配置独立的日志文件
* 需要有默认的 `CORS` 配置
** 已经有固定配置，只需要在对应段落里加 `include conf.d/include/a1-cors;`
* 请求速率设置
** REST 接口默认 `30次/秒`，其它 `100次/秒`
* 后端服务器必须使用 `upstream` 来配置，禁止 `proxy_pass` 中直接使用后端地址。

===== 配置示例

以下是一个符合基本约定的最简示例，线上服务还需要根据情况增加对应配置。

[source]
----
upstream tomcatcluster
{
    server ebs-ali-beijing-app12:8080 max_fails=50 weight=3;
    server ebs-ali-beijing-app13:8080 max_fails=50 weight=3;
    server ebs-ali-beijing-app14:8080 max_fails=50 weight=3;
    server ebs-ali-beijing-app15:8080 max_fails=50 weight=3;

    keepalive 16;

    check interval=3000 rise=1 fall=5 timeout=2000 type=http;
    check_http_send "HEAD /status HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx;
}

server
{
    listen 80 default backlog=4096;
    server_name a1.easemob.com;
    charset UTF-8;

    access_log /home/easemob/apps/log/nginx/usergrid-access.log main;
    error_log /home/easemob/apps/log/nginx/usergrid-error.log;

    http_accounting_id a1.easemob.com;
    include conf.d/include/proxy.cfg;

    location ~* ^/(?P<org_name>[0-9a-zA-Z-_]+)/(?P<app_name>[0-9a-zA-Z]+)/token$ {
        include conf.d/include/a1-cors;
        limit_req zone=two burst=500 nodelay;
        proxy_pass http://tomcatcluster;
    }
    location /system/ {
      # disable system initialize api
      return 405 'Not Allowed';
    }
    location / {
        include conf.d/include/a1-cors;
        limit_req zone=one burst=500 forbid_action=@ratelimit30;
        proxy_pass http://tomcatcluster;
    }
}
----

==== 作为静态服务的配置

===== 适用范围
作为静态服务的域名包括

* 环信管理后台
** console.easemob.com
** console.vip1.easemob.com
* WebIM
** webim.easemob.com
** webim.vip1.easemob.com
* 主站
** www.easemob.com
* 文件下载
** dl.easemob.com/downloads.easemob.com

===== 配置规则

站点的静态文件保存在 `/data/apps/data/nginx/` 目录下与站点名相同的子目录。

===== 配置示例
[source]
----
server {
    listen   80 ;
    server_name www.easemob.com easemob.com www.easemob.org;

    root /home/easemob/apps/data/nginx/www.easemob.com;
    index index.php index.html index.htm;

    location / {
      autoindex off;
      charset UTF-8;
    }
}
----

==== 日志与监控

===== 日志关键字总结与应对

===== 监控

==== 参数优化
