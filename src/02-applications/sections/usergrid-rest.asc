=== Usergrid REST服务

==== 概况

Usergrid REST 服务提供了接口，用于app取Token/Chatgroups操作/批量发消息/聊天记录查询/用户操作/用户关系操作等。

==== 基础环境

安装 `Tomcat`，版本 `7.0.55`

===== 配置文件

[source,indent=0]
./data/apps/opt/tomcat/conf/server.xml
----
include::tomcat/server.xml[]
----

`catalina.sh` 文件开头需要有以下内容

./data/apps/opt/tomcat/bin/catalina.sh
----
source /data/apps/config/usergrid/usergrid-env.sh

CATALINA_PID="/home/easemob/apps/var/tomcat/tomcat.pid"
JAVA_OPTS="-server -Xms10g -Xmx10g  -XX:MaxGCPauseMillis=500 -XX:GCPauseIntervalMillis=200 -XX:ParallelGCThreads=8 -XX:ConcGCThreads=2 -XX:+UseG1GC -verbose:gc -XX:+PrintGCDetails -Xloggc:/data/apps/log/tomcat/tomcat-gc.log -XX:GCPauseIntervalMillis=8000"
JAVA_OPTS="-Dlogback.configurationFile=/data/apps/config/usergrid/logback-default.xml $JAVA_OPTS"
CATALINA_OUT="/home/easemob/apps/log/tomcat/tomcat.out"
----

./data/apps/config/usergrid/usergrid-env.sh
----
export usergrid_config_file=/data/apps/config/usergrid/usergrid-custom.properties
export USERGRID_LOG_CONFIG_FILE=/data/apps/config/usergrid/logback.xml
----

其中 `logback.xml` / `usergrid-custom.properties` 这两个配置文件由 ansible 提供，对应的role `ci/usergrid_properties`。

==== 基本操作命令

===== 启动
----
sudo monit start tomcat
----

===== 停止
----
sudo monit stop tomcat
----

===== 查看部署的业务代码版本
----
curl -s http://ebs-ali-beijing-app11:8080/status
----
输出
----
{
  "timestamp" : 1429769528874,
  "duration" : 0,
  "status" : {
    "started" : 1429359510417,
    "uptime" : 410018457,
    "version" : "1.0.0-370-20150418-1.0.7-7-g4efa072",
    "cassandraAvailable" : true
  }
}
----

==== 业务代码更新（CI）

CI 中执行 ansible-playbook 用于更新。

对应 ansible 的 role 为 `ci/tomcat-usergrid`，依赖 role `ci/usergrid_properties`。

==== 日志与监控

日志路径为 `/data/apps/log/usergrid/usergrid.log`

==== 参数优化
