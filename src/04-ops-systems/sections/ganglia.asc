=== Ganglia

==== 概况

`Ganglia` 用于收集服务器系统级别监控数据。
`Ganglia` 部署分为四种角色：

* 被监控服务器，运行 `gmond`
* 监控数据中转，运行 `gmond`
* 数据存储，运行 `gmetad`
* 数据展示，运行 `ganglia-web`，一个 php 实现的 web 站点。

ganglia agent 采集的数据，按业务组进行汇总收集，每个业务组预先分配一个端口。
现在已经使用到端口列表：

* 8671 `storm`
* 8672 `kafka`
* 8673 `ejabberd`
* 8674 `jmetrics-db`
* 8675 `zk` zookeeper
* 8676 `app` tomcat/usergrid-rest
* 8677 `jmetrics`
* 8678 `thrift`
* 8679 `db` cassandra
* 8680 `mdb` cassandra
* 8681 `redis`
* 8682 `dp` 大数据
* 8683 `kefu` 客服
* 8684 `kefu-metrics` 客服
* 8685 `web`
* 8686 `ops`
* 8687 `push` easemob-push
* 8688 `mserver`
* 8689 `mserver-metrics`
* 8690 `resolver`

* 8691 `test-client` 压测客户端
* 8692 `codis`

==== 安装 gmond - Agent

ganglia agent 部署在被监控的机器上，通过 ansible 来进行安装配置。

机器创建时，需要进行的配置包括：

* inventory 配置文件中设定对应的组名和端口，为方便管理，一般在 group_vars 中配置。格式为：

[source]
----
gmond:
  group_name: ebs-ali-beijing-redis
  group_node:
    host: ebs-ali-beijing-log
    port: 8681
----

* playbook 中应用 roles 指定: `monitor/ganglia_gmond`

==== 安装 gmond - Group Node

业务组的收集节点（Group Node）部署在各个集群的 log 机器上。

创建配置文件：
配置文件位于 /etc/ganglia/ 目录下，对应文件名格式 gmond.conf-{PORT}-{GROUP_NAME}，如 gmond.conf-8681-redis。
复制其它业务组配置文件，或者复制 template-gmond.conf，修改其中的属性：

* `globals` 部分 `override_hostname` 修改为监控对应的组名
* `cluster` 部分 `name` 属性修改为对应的组名
* `udp_recv_channel` 部分 `port` 修改为制订的端口
* `tcp_accept_channel` 部分 `port` 修改为指定的端口

配置好之后，在 log 机器执行 `sudo /usr/sbin/gmond -c /etc/ganglia/gmond.conf-{PORT}-{GROUP_NAME}` 来启动。


==== 配置 gmetad

gmetad 从组节点收集数据，并保存到 RRD 文件中。

现有 2 台 ganglia 数据节点：

* 节点1 http://monitoring.easemob.com/ganglia/
* 节点2 qc-bj2-monitoring (http://hadoop.easemob.com:10000/ganglia/)

每组节点只需其中一台配置保存。目前北京数据中心监控主要保存在节点1，杭州数据中心监控数据主要在节点2。


修改 gmetad 配置文件：在数据节点上，修改 /etc/ganglia/gmetad.conf 配置文件，增加对应组的一行配置：

[source]
----
data_source "Ali Beijing Redis" ebs-ali-beijing-log.easemob.com:8681
----

重启 gmetad

[source,console]
----
sudo service gmetad reload
----

==== 部署 ganglia-web

ganglia-web 是一个 php 站点，与 gmetad 部署在同一台服务器。
安装过程参考官方文档。

===== 权限控制

当前我们的 ganglia-web 使用 http basic auth 方式做身份验证。
密码文件保存在 monitoring.easemob.com 服务器的 /etc/ganglia/ganglia.htpasswd

==== 日常操作步骤
