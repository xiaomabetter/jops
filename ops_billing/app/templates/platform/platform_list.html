{% extends 'base/_base_list.html' %}
{% block table_search %}
{% endblock %}
{% block table_container %}
{% if g.user.role == 'administrator' %}
    <div class="uc pull-left m-r-5">
        <input class="btn btn-primary btn-sm" id="platform_create" type="button" value="创建">
    </div>
{% endif %}
<table class="table table-striped table-bordered table-hover " id="platform_list_table" >
    <thead>
    <tr>
        <th class="text-center">
            <input type="checkbox" id="check_all" class="ipt_check_all" >
        </th>
        <th class="text-center">平台</th>
        <th class="text-center">地址</th>
        <th class="text-center">所属地区</th>
        <th class="text-center">类型</th>
        <th class="text-center">创建时间</th>
        <th class="text-center">动作</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
{% include 'platform/_create_platform_modal.html' %}
{% endblock %}
{% block custom_foot_js %}
<script src="{{ url_for('static', filename='js/jquery.cookie.js') }}"></script>
<script>
function initTable() {
    var options = {
        ele: $('#platform_list_table'),
        columnDefs: [
            {targets: 6, createdCell: function (td, cellData, rowData) {
                var transfer_btn = '<a class="btn btn-xs m-l-xs btn-info" id="do_transfer_url" data-uid="PK">跳转</a>'.replace('PK',cellData);
                {% if g.user.role == 'administrator' %}
                    var update_btn = '<a href="{{ url_for('platform.platform_update',platformid='PK') }}" class="btn btn-xs m-l-xs btn-info">更新</a>'.replace('PK',cellData);
                    var del_btn = '<a class="btn btn-xs btn-danger m-l-xs btn_permission_group_delete" data-uid="PK">删除</a>'.replace('PK', cellData);
                    $(td).html(transfer_btn+ update_btn + del_btn)
                {% else %}
                    $(td).html(transfer_btn)
                {% endif %}
            }}
        ],
        ajax_url: "{{ url_for('platform-api.platforms_api') }}",
        columns: [
            {data: "id" },{data: "description" },{data: "platform_url" },{data: "location" },{data: "catagory" },
            {data: "date_created"},{data: "id" }
        ],
        op_html: $('#actions').html()
        };
    jumpserver.initDataTable(options);
}

$(document).ready(function(){
    initTable();
}).on('click', '#do_transfer_url', function () {
    var $this = $(this);
    var platform_id = $this.data('uid');
    var current_domain = window.location.hostname

    $.cookie('platform_id',platform_id,{path:'/',domain:current_domain})　

    $.get("{{ url_for('platform-api.platforms_proxy_api') }}",{}, function(result){
        if (result['status']) {
            var platform_proxy_port = result['data']
            console.log(platform_proxy_port)
            var url = "http://" + current_domain + ":" + platform_proxy_port;
            window.open(url,'luna')
        } else {
            toastr.error(result['msg']);
        }
    });
})

.on('click', '.btn_permission_group_delete', function () {
    var $this = $(this);
    var $data_table = $('#system_user_list_table').DataTable();
    var name = $(this).closest("tr").find(":nth-child(2)").children('a').html();
    var platformid = $this.data('uid');
    var the_url = "{{ url_for('platform-api.platform_api',platformid='PK') }}".replace('PK',platformid);
    objectDelete({}, name, the_url);
    setTimeout( function () {
        $data_table.ajax.reload();
    }, 1000);
})

$("#platform_create").on("click",function(){
   $('#platform_create_modal').modal('show');
})
</script>
{% endblock %}



