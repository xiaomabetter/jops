{% extends '_base_bill_list.html' %}
{% load i18n %}
{% load static %}

{% block content_left_head %}
<!-- Single button -->
<div class="btn-group">
  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    分类 {{asset_category}} <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="{% url 'assets:bill-slb-list' %}">SLB</a></li>
    <li><a href="{% url 'assets:bill-ecs-list' %}">ECS</a></li>
    <li><a href="{% url 'assets:bill-rds-list' %}">RDS</a></li>
  </ul>
</div>
{% endblock %}

{% block table_search %}
    <form id="search_form" method="get" action="" class="pull-right form-inline">
        <div class="input-group">
            <input type="text"  class="form-control input-sm" style="display:none" name="nodeid"  value="">
        </div>
        <div class="form-group" id="date">
            <div class="input-group input-daterange" id="datepicker">
                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                <input type="text" class="input-sm form-control" style="width: 100px;height:34px" name="date_from" value="{{ date_from|date:'Y-m-d' }}">
                <span class="input-group-addon">to</span>
                <input type="text" class="input-sm form-control" style="width: 100px;height:34px" name="date_to" value="{{ date_to|date:'Y-m-d' }}">
            </div>
        </div>
        <div class="input-group">
            <input type="text"  class="form-control input-sm" style="height:34px" name="keyword" placeholder="{% trans 'Search'  %}" value="{{ keyword }}">
        </div>
        <div class="input-group">
            <div class="input-group-btn">
                <button id='search_btn' style="height:34px" type="submit" class="btn btn-sm btn-primary">
                    {% trans "Search"  %}
                </button>
            </div>
        </div>
    </form>
{% endblock %}

{% block table_head %}
    <th class="text-center">实例ID</th>
    <th class="text-center">实例名称</th>
    <th class="text-center">时间</th>
    <th class="text-center">费用</th>
{% endblock %}

{% block table_body %}
    {% for object in task_list %}
        <tr class="gradeX">
            <td class="text-center">{{ object.instanceid }}</td>
            <td class="text-center">{{ object.instancename }}</td>
            <td class="text-center">
                {{ object.day }}
            </td>
            <td class="text-center">{{ object.cost }}</td>
        </tr>
    {% endfor %}
{% endblock %}
{% block content_bottom_left %}
    <div class="input-group">
      <span class="input-group-btn">
        <button class="btn btn-sm" type="button">{{ nodegroup }} 总金额: </button>
      </span>
      <input type="text" class="form-control" value="{{ sumcost }}">
    </div><!-- /input-group -->
{% endblock %}

{% block custom_foot_js %}
<script src="{% static 'js/plugins/datepicker/bootstrap-datepicker.js' %}"></script>
<script src="{% static 'js/plugins/honeySwitch/bootstrap-select.min.js' %}"></script>
<script>
$(document).ready(function() {
    $('table').DataTable({
        "searching": false,
        "paging": false,
        "bInfo" : false,
        "order": []
    });
   $('.select2').select2({
        dropdownAutoWidth : true,
        width: 'auto'
    });
    $('#date .input-daterange').datepicker({
        format: "yyyy-mm-dd",
        todayBtn: "linked",
        keyboardNavigation: false,
        forceParse: false,
        calendarWeeks: true,
        autoclose: true
    });
    initTree();
})

function initTree() {
    var setting = {
        view: {
            dblClickExpand: false,
            showLine: true
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        edit: {
            enable: true,
			showRemoveBtn: false,
			showRenameBtn: false,
            drag: {
                isCopy: true,
                isMove: true
            }
        },
        callback: {
            beforeClick: beforeClick,
            onSelected: onSelected,
        }
    };

    var zNodes = [];
    $.get("{% url 'api-assets:nodeslb-list' %}", function(data, status){
        $.each(data, function (index, value) {
            value["pId"] = value["parent"];
            {#if (value["key"] === "0") {#}
            value["open"] = true;
            {# }#}
            value["name"] = value["value"] + ' (' + value['assets_amount'] + ')';
            value['value'] = value['value'];
        });
        zNodes = data;
        $.fn.zTree.init($("#assetTree"), setting, zNodes);
        zTree = $.fn.zTree.getZTreeObj("assetTree");
		rMenu = $("#rMenu");
		selectQueryNode();
    });
}

function beforeClick(treeId, treeNode, clickFlag) {
    return true;
}

function selectQueryNode() {
    var query_node_id = $.getUrlParam("nodeid");
    var cookie_node_id = getCookie('node_selected');
    var node;
    var node_id;

    if (query_node_id !== null) {
        node_id = query_node_id
    } else if (cookie_node_id !== null) {
        node_id = cookie_node_id;
    }

    node = zTree.getNodesByParam("id", node_id, null);
    if (node){
        zTree.selectNode(node[0]);
    }
}

function beforeDrag() {
    return true
}

function onSelected(event, treeNode) {
    //var url = asset_table.ajax.url();
    //url = setUrlParam(url, "node_id", treeNode.id);
    //console.log(treeNode.id);
    //setCookie('node_selected', treeNode.id);
    //asset_table.ajax.url(url);
    //asset_table.ajax.reload();
    $("input[name='nodeid']").val(treeNode.id);
}

</script>
{% endblock %}

